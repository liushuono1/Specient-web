{% extends 'base.html' %}
{% load static %}

{% block title %}SpecAgent AI - Sandbox{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<style>
    /* Custom Scrollbar for logs */
    .logs-scroll::-webkit-scrollbar { width: 6px; }
    .logs-scroll::-webkit-scrollbar-track { background: #f9fafb; }
    .logs-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    
    .typing-indicator span {
        animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes blink {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
    }
</style>
{% endblock %}

{% block content %}
<div id="demo-app" class="h-[calc(100vh-64px)] flex flex-col bg-gray-50 pt-2 text-spec-navy overflow-hidden">
    
    <!-- Header / Toolbar -->
    <div class="h-12 border-b border-gray-200 px-4 flex items-center justify-between bg-white shadow-sm z-10">
        <div class="flex items-center space-x-2">
            <span class="px-2 py-0.5 rounded text-xs font-mono bg-spec-earth/10 text-spec-earth border border-spec-earth/20">SANDBOX MODE</span>
            <span class="text-sm font-bold text-gray-700">Target: [[ industryName ]] Agent</span>
        </div>
        <div>
            <a href="/portal/dashboard" class="text-xs text-gray-500 hover:text-spec-earth">Exit Sandbox ✕</a>
        </div>
    </div>

    <!-- Main Workspace (3 Columns) -->
    <div class="flex-grow flex overflow-hidden">
        
        <!-- Left: Spec Config -->
        <div class="w-64 border-r border-gray-200 flex flex-col bg-gray-50">
            <div class="p-3 border-b border-gray-200 font-bold text-xs uppercase text-gray-400">Spec Configuration</div>
            <div class="p-4 space-y-4 overflow-y-auto">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Strictness Level</label>
                    <select class="w-full bg-white border border-gray-300 rounded text-xs p-2 text-gray-700 focus:border-spec-earth outline-none">
                        <option>High (Zero Tolerance)</option>
                        <option>Medium (Balanced)</option>
                        <option>Low (Creative)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Output Format</label>
                    <select class="w-full bg-white border border-gray-300 rounded text-xs p-2 text-gray-700 focus:border-spec-earth outline-none">
                        <option>Standard JSON</option>
                        <option>PDF Document</option>
                        <option>Visualization</option>
                    </select>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <div class="text-xs font-medium text-gray-400 mb-2">Active Rules</div>
                    <div class="space-y-2">
                        <div class="flex items-center text-xs text-green-600">
                            <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                            GB/T 9704 Compliant
                        </div>
                        <div class="flex items-center text-xs text-green-600">
                            <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                            Refuse Hallucinations
                        </div>
                        <div class="flex items-center text-xs text-green-600">
                            <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                            Audit Log Enabled
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center: Chat Interface -->
        <div class="flex-1 flex flex-col bg-white relative border-r border-gray-200">
            <!-- Chat History -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-white" ref="chatContainer">
                <div v-for="(msg, index) in messages" :key="index" :class="{'flex justify-end': msg.role === 'user', 'flex justify-start': msg.role === 'agent'}">
                    <div :class="{'bg-spec-earth/10 text-spec-navy border border-spec-earth/20': msg.role === 'user', 'bg-gray-50 text-gray-700 border border-gray-200': msg.role === 'agent'}" class="max-w-[80%] rounded-lg px-4 py-2 text-sm shadow-sm">
                        <div v-if="msg.role === 'agent'" class="text-xs text-spec-earth mb-1 font-bold">SpecAgent</div>
                        <div style="white-space: pre-wrap;">[[ msg.content ]]</div>
                    </div>
                </div>
                <!-- Loading State -->
                <div v-if="isProcessing" class="flex justify-start">
                     <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2">
                        <div class="typing-indicator text-gray-400 font-bold text-xl flex space-x-1">
                            <span>.</span><span>.</span><span>.</span>
                        </div>
                     </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-gray-50 border-t border-gray-200">
                <div class="flex gap-2">
                    <input type="text" v-model="userInput" @keyup.enter="sendMessage" placeholder="Enter your instruction here (e.g. 'Generate a flight plan...')" 
                        class="flex-1 bg-white border border-gray-300 rounded-md px-4 py-2 text-sm text-gray-700 focus:ring-1 focus:ring-spec-earth outline-none shadow-sm">
                    <button @click="sendMessage" class="px-4 py-2 bg-spec-earth text-white font-bold rounded-md text-sm hover:bg-opacity-90 shadow-sm">
                        Execute
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: Live Preview -->
        <div class="w-1/3 flex flex-col bg-spec-bg/50">
            <div class="p-3 border-b border-gray-200 bg-gray-50 font-bold text-xs uppercase text-gray-500 flex justify-between">
                <span>Live Preview / Output</span>
                <span v-if="successToast" class="text-green-600 flex items-center animate-pulse">✓ Spec Verified</span>
            </div>
            <div class="flex-1 p-4 overflow-y-auto bg-gray-50/50">
                <!-- Placeholder for different content types -->
                <div v-if="!currentOutput" class="h-full flex items-center justify-center text-gray-400 text-sm italic">
                    Waiting for agent output...
                </div>
                
                <div v-else class="animate-fade-in-up">
                    <div v-if="currentOutput.type === 'document'" class="bg-white text-gray-900 p-6 shadow-md border border-gray-200 min-h-[300px] text-xs font-serif leading-relaxed">
                        <div class="text-center font-bold text-lg mb-4 underline">[[ currentOutput.title ]]</div>
                        <div v-html="currentOutput.body"></div>
                    </div>
                    
                    <div v-if="currentOutput.type === 'json'" class="bg-[#1e293b] p-4 rounded-md border border-gray-700 font-mono text-xs text-green-400 overflow-x-auto shadow-md">
                        <pre>[[ JSON.stringify(currentOutput.data, null, 2) ]]</pre>
                    </div>

                    <div v-if="currentOutput.type === 'chart'" class="bg-white p-4 rounded-md border border-gray-200 flex flex-col items-center justify-center h-[300px] shadow-md">
                        <div class="w-full flex justify-end gap-1 items-end h-[200px]">
                            <div class="w-8 bg-blue-500 h-[60%]"></div>
                            <div class="w-8 bg-spec-earth h-[80%] animate-pulse"></div>
                            <div class="w-8 bg-purple-500 h-[40%]"></div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">Data Visualization Preview</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom: Log Console -->
    <div class="h-32 bg-white border-t border-gray-300 flex flex-col font-mono text-xs">
        <div class="px-4 py-1 bg-gray-100 text-gray-500 flex justify-between border-b border-gray-200">
            <span>SpecAgent Kernel Logs</span>
            <span>Status: [[ isProcessing ? 'PROCESSING' : 'IDLE' ]]</span>
        </div>
        <div class="flex-1 p-2 overflow-y-auto logs-scroll space-y-1 text-gray-600" ref="logContainer">
            <div v-for="(log, idx) in logs" :key="idx">
                <span class="text-spec-earth/80">[[ log.time ]]</span> [[ log.msg ]]
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                industryName: '{{ industry_id|default:"General"|title }}',
                messages: [
                    { role: 'agent', content: 'Agent initialized. Spec verified v2.1. Waiting for instruction.' }
                ],
                userInput: '',
                isProcessing: false,
                logs: [],
                currentOutput: null,
                successToast: false
            }
        },
        mounted() {
            this.addLog('Kernel started successfully.');
            this.addLog('Loading industry specs for: ' + this.industryName);
        },
        methods: {
            addLog(msg) {
                const time = new Date().toLocaleTimeString([], { hour12: false });
                this.logs.push({ time, msg });
                this.$nextTick(() => {
                    const container = this.$refs.logContainer;
                    if (container) container.scrollTop = container.scrollHeight;
                });
            },
            sendMessage() {
                if (!this.userInput.trim() || this.isProcessing) return;
                
                // Add user message
                this.messages.push({ role: 'user', content: this.userInput });
                const command = this.userInput;
                this.userInput = '';
                this.isProcessing = true;
                this.successToast = false;
                this.currentOutput = null;

                // Simulate Agent "Thinking" steps with logs
                setTimeout(() => this.addLog(`Parsing natural language: "${command}"`), 500);
                setTimeout(() => this.addLog(`Matching against Spec definitions...`), 1200);
                setTimeout(() => this.addLog(`Checking policy constraints...`), 1800);
                setTimeout(() => {
                    this.addLog(`Spec validation passed. Transform -> Action.`); 
                    this.successToast = true;
                }, 2500);

                // Mock Response after delay
                setTimeout(() => {
                    this.isProcessing = false;
                    this.generateMockResponse(command);
                }, 3000);
            },
            generateMockResponse(command) {
                // Simple keyword matching mock logic
                let responseText = "Task completed successfully according to spec.";
                let output = { type: 'json', data: { status: 'ok' } };

                const cmd = command.toLowerCase();

                if (cmd.includes('document') || cmd.includes('report') || cmd.includes('write')) {
                    responseText = "Generated compliant document based on GB/T standard.";
                    output = {
                        type: 'document',
                        title: 'Generated Report #2026-X',
                        body: '<p><strong>Abstract:</strong> This is a spec-generated content block.</p><p>According to the regulations...</p><br/><hr/><p>Signed: SpecAgent</p>'
                    };
                } else if (cmd.includes('chart') || cmd.includes('analyze') || cmd.includes('data')) {
                    responseText = "Data analysis complete. Visualization rendered.";
                    output = { type: 'chart' };
                } else if (cmd.includes('flight') || cmd.includes('book')) {
                    responseText = "Itinerary locked. Policy check passed.";
                    output = {
                        type: 'json',
                        data: {
                            flight: 'CA1234',
                            status: 'CONFIRMED',
                            policy_check: 'PASSED'
                        }
                    };
                }

                this.messages.push({ role: 'agent', content: responseText });
                this.currentOutput = output;
                this.addLog(`Execution finished. Output rendered.`);
            }
        }
    }).mount('#demo-app')
</script>
{% endblock %}
